! Configuration File for keepalived

global_defs {
    router_id whpg-s               # 각 서버마다 고유한 ID (호스트 이름 등으로 설정 권장)
    script_user gpadmin            # 스크립트를 이 사용자로 실행합니다.
    # notification_email {
    #   admin@example.com
    # }
    # notification_email_from keepalived@example.com
    # smtp_server 127.0.0.1
    # smtp_connect_timeout 30
    enable_script_security         # 스크립트 실행 보안 강화 (권장)
    # vrrp_skip_check_adv_addr
    # vrrp_strict
    # vrrp_garp_interval 0
    # vrrp_gna_interval 0
}

vrrp_script chk_service_health {
    script "/etc/keepalived/check_my_service.sh" # 서비스 상태 체크 스크립트
    interval 1                                   # 1초마다 실행
    weight 30                                    # 스크립트 실패 시 우선순위 30 감소, standby 가 정상인 경우 30 증가
    fall 3                                       # 3회 실패 시 FAULT 상태로 전환
    rise 1                                       # 1회 성공 시 다시 정상 상태로 전환
}

vrrp_instance VI_1 {
    state BACKUP             # 이 노드의 초기 상태: BACKUP or MASTER
    interface eth1           # VRRP 패킷을 주고받을 네트워크 인터페이스 (실제 인터페이스명으로 변경)
    virtual_router_id 51     # VRRP 라우터 ID (이 클러스터 내에서 고유해야 함, 1-255)
    priority 98              # 이 노드의 우선순위 (Master Node를 2보다 높게 설정)

    #nopreempt
    preempt                  # Master에서WHPG 종료로 priority가 BACKUP보다 낮아지면, 강제로 BACKUP 이 MASTET로 승격, WHPH Master 시작시킴

    advert_int 1             # VRRP 광고 간격 (초)
    authentication {
        auth_type AH         # 인증 방식 (PASS 또는 AH)
        auth_pass secretpw   # 인증 비밀번호 (두 노드 동일하게 설정)
    }

    virtual_ipaddress {
        #192.168.56.100/24 dev eth1 label eth1:0    # 클라이언트가 접근할 가상 IP 주소 (VIP)
        192.168.56.100/24    # 클라이언트가 접근할 가상 IP 주소 (VIP)
    }

    track_script {
        chk_service_health
    }

    notify_master "/etc/keepalived/notify_master.sh MASTER"
    notify_backup "/etc/keepalived/notify_state_change.sh BACKUP"
    #notify_fault "/etc/keepalived/notify_state_change.sh FAULT"
    notify_stop "/etc/keepalived/notify_stop.sh BACKUP"
}
